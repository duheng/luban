"use strict";const e=require("webpack"),s=require("terser-webpack-plugin"),r=require("copy-webpack-plugin"),{CleanWebpackPlugin:n}=require("clean-webpack-plugin"),i=require("add-asset-html-webpack-plugin"),l=require("vue-loader/lib/plugin"),t=require("../plugins/format-progress-plugin"),{useDllPath:o}=require("../utils/common"),{useCache:u,terserCacheDirectory:a}=require("../utils/buildCache"),c=require("fs"),p=require("path"),m=process.cwd(),{entry:d,dllReferencePlugin:g,loadDllAssets:y,genAlias:h}=require("../utils/common"),w=require("./rules"),x=s=>{let u=[new e.ProgressPlugin(t),new n,new e.IgnorePlugin({resourceRegExp:/^\.\/locale$/,contextRegExp:/moment$/}),new e.DefinePlugin({"process.env":{NODE_ENV:JSON.stringify(process.env.NODE_ENV)},API:JSON.stringify(s.api[process.env.NODE_ENV]),STATIC:JSON.stringify(s.static[process.env.NODE_ENV])}),new e.optimize.ModuleConcatenationPlugin];"react"==s.platform?u.push(new e.ProvidePlugin({React:"react"})):"vue"==s.platform&&u.push(new l),s.library&&Object.keys(s.library).length>0&&c.existsSync(o())&&(u.push(...g(s)),u.push(new i(y(s))));const a=p.resolve(s.base,s.assets||"assets"),m=[];return c.existsSync(a)&&c.statSync(a).isDirectory()&&m.push({from:a,to:s.assets||"assets"}),s.copy instanceof Array&&s.copy.length>0&&m.push(...s.copy),u.push(new r({patterns:[...m]})),u};module.exports=e=>({context:p.join(m),entry:d,externals:e.externals||{},target:"web",module:w(e),resolve:{modules:[m,p.resolve(__dirname,"..","..","node_modules"),"node_modules"],alias:{...h(p.join(m,e.base),e)},extensions:[".js",".jsx",".scss",".css",".less",".ts",".tsx",".vue",".json"]},resolveLoader:{modules:[p.resolve(__dirname,"..","..","node_modules")],moduleExtensions:["-loader"]},plugins:x(e),optimization:{splitChunks:{minSize:1,maxAsyncRequests:1e5,maxInitialRequests:1e5,cacheGroups:{default:!1,vendors:!1}},namedModules:!0,minimize:!1,minimizer:["production"===process.env.NODE_ENV?new s({minify:s.esbuildMinify,exclude:/node_modules|dll|.luban-cache/,cache:!!u&&a,parallel:!0,extractComments:!0,terserOptions:{}}):null].filter(Boolean)}});
